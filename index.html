<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Phaser - Making your first game, part 9</title>
    <script src="phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

var tilesprite;

function preload() {
	game.cache.removeAll;
  game.load.image('sky', 'assets/sky.png');
  game.load.image('ground', 'assets/platform.png');
  game.load.image('star', 'assets/star.png');
	game.load.image('redsky', 'assets/redsky.jpg');
  game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
	game.load.spritesheet('unicorn', 'assets/unicorn.png', 206, 110);
	game.load.spritesheet('dash', 'assets/unicorn.png', 479, 181);
	game.load.image('background1', 'assets/background1.png');
	game.load.image('mountain', 'assets/mountain.png');
	game.load.image('platform1', 'assets/platform1.png');
	game.load.image('platform2', 'assets/platform2.png');
	game.load.image('platform3', 'assets/platform3.png');
	game.load.physics('physics', 'assets/physics13.json');
	game.load.image('platform4', 'assets/platform4.png');
	game.load.image('platform5', 'assets/platform5.png');
	game.load.image('platform6', 'assets/platform6.png');
	game.load.image('platform7', 'assets/platform7.png');
	game.load.image('pentagram', 'assets/pentagram.png');
	game.load.spritesheet('explosion', 'assets/explosion.png', 63, 63);
	game.load.audio('odin', 'assets/odin.mp3');
	game.load.audio('awaken', 'assets/awaken.mp3');
	game.load.audio('dash', 'assets/dash.wav');
	game.load.audio('explosion', 'assets/explosion.wav');

}

var explosion;
var explosionSound;
var dashSound;
var player;
var playerMaterial;
var platforms;
var platform1;
var platform2;
var cursors;
var dashing = false;
var platformMaterial;
var pentagram;
var score = 0;
var scoreText;
var addScore = 100;

function create() {

    game.physics.startSystem(Phaser.Physics.P2JS);

		game.physics.p2.gravity.y = 1000;
		game.physics.p2.friction = 0;
		game.physics.p2.restitution = 0;

		game.world.setBounds(0, -100, 800, 800);
		game.physics.p2.setBoundsToWorld(true, false, true, false);

    background = game.add.tileSprite(0, 100, 800, 700, 'background1');
		mountain = game.add.tileSprite(0, 100, 800, 700, 'mountain');

		var audios = {
			1: 'odin',
			2: 'awaken'
		}

		var num = Math.round(Math.random() * (2 - 1) + 1);

		var music = game.add.audio(audios[num]);
		music.play();
		explosionSound = game.add.audio('explosion');
		dashSound = game.add.audio('dash');

		platforms = game.add.group();
		//
    platforms.enableBody = true;

		game.physics.p2.restitution = -10;

		platform1 = game.add.sprite(800, 460, 'platform1');

		pentagram = game.add.sprite(1200, 280, 'pentagram');



		player = game.add.sprite(100, 260, 'unicorn');

		// player.fixedToCamera = true;

		game.physics.p2.enable([player, pentagram, platform1], false);

		platform1.body.clearShapes();
		platform1.body.loadPolygon('physics', 'platform1');

		player.body.clearShapes();
		player.body.loadPolygon('physics', 'unicorn');



		player.body.restitution = 0;
		player.body.fixedRotation = true;
		// player.body.kinematic = true;
		platform1.body.restitution = 0;

		platform1.body.static = true;
		pentagram.body.static = true;
		platform1.body.data.gravityScale = 0;


		player.animations.add('run', [26, 25, 24, 23, 22, 21, 20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0], 50, true);

		player.animations.add('dash', [20, 21, 22,23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35], 30, true);


		game.camera.follow(player);

		jumpButton = game.input.keyboard.addKey(Phaser.Keyboard.Z);
		dashButton = game.input.keyboard.addKey(Phaser.Keyboard.X);

		playerMaterial = game.physics.p2.createMaterial('player', player.body);
		platformMaterial = game.physics.p2.createMaterial('platform');
		explosionMaterial = game.physics.p2.createMaterial('explosion');

		platform1.body.setMaterial(platformMaterial);

		var playerPlatformCM = game.physics.p2.createContactMaterial(playerMaterial, platformMaterial);
		// debugger;
    playerPlatformCM.restitution = 0;
		playerPlatformCM.friction = 0;
		playerPlatformCM.stiffness = 1000000;
		playerPlatformCM.damping = 0;
		playerPlatformCM.relaxation = 4;
		playerPlatformCM.contactSkinSize =  0;
		playerPlatformCM.frictionRelaxation = 4;
		playerPlatformCM.frictionStiffness = 1000000;

		var playerExplosionCM = game.physics.p2.createContactMaterial(playerMaterial, explosionMaterial);
		// debugger;
    // playerExplosionCM.restitution = 0;
		// playerExplosionCM.friction = 0.6;
		// playerExplosionCM.stiffness = 1000000;
		// playerExplosionCM.damping = 0;
		// playerExplosionCM.relaxation = 4;
		playerExplosionCM.contactSkinSize =  100;
		// playerExplosionCM.frictionRelaxation = 4;
		// playerExplosionCM.frictionStiffness = 1000000;

		scoreText = game.add.text(game.camera.view.width - 780, game.camera.view.y, 'score: ' + score, { fontSize: '32px', fill: 'white' });

}


var velocity = -400;
var dead = false;

function update() {
	game.world.bringToTop(scoreText);

	if (dead) {
		velocity = 0;
		// player.body.mass = 0
		player.body.kinematic = true;
		player.visible = false;
		player.alpha = 0;
	}

	if (player.body) player.body.x = 100;
	background.tilePosition.x -= 1;
	mountain.tilePosition.x -= 2;

	scoreText.position.y = game.camera.view.y
	if (pentagram.body) {
		pentagram.body.velocity.x = velocity;

	}

	if (dashButton.isDown && !dashing)
    {
        game.physics.p2.gravity.y = 0;
				if (player.body) player.body.velocity.y = 0;
				dashing = true;
				dashSound.play();
				player.loadTexture('dash');
				velocity -= 500;
      	setTimeout(function () {
					game.physics.p2.gravity.y = 1000;
					player.loadTexture('unicorn');
					dashing = false;
					if (!dead) {
						velocity += 500
					} else {
						velocity = 0;
					}
      	}, 500)
    }

	if (player.body && !dead && (checkIfCollidingY() || player.body.y > 800)) {
		dead = true;
		explosionSound.play();
		explosion = game.add.sprite(player.body.x, player.body.y, 'explosion');
		explosion.animations.add('explode', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24], 24, false);
		explosion.animations.play('explode');
		setTimeout(function () {
			explosion.destroy();
		}, 2000);
	}

	if (pentagram.body && player.body && checkIfCollidingX(player, pentagram) && !dashing) {
		velocity = 0;
		explosionSound.play();
		explosion = game.add.sprite(player.body.x, player.body.y, 'explosion');
		explosion.animations.add('explode', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24], 25, true);
		explosion.animations.play('explode');
		player.destroy();
		setTimeout(function () {
			explosion.destroy();
		}, 1000);

	} else if (pentagram.body && player.body && checkIfCollidingX(player, pentagram) && dashing) {
		explosionSound.play();
		explosion = game.add.sprite(pentagram.body.x, pentagram.body.y, 'explosion');
		explosion.animations.add('explode', [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24], 25, true);
		explosion.animations.play('explode');

		game.physics.p2.enable([explosion], false);
		explosion.body.setMaterial(explosionMaterial);
		explosion.body.velocity.x = velocity;
		explosion.body.static = true;
		explosion.body.mass = 0;
		// explosion.body.kinematic = true;

		setTimeout(function () {
			explosion.destroy();
		}, 1000);

		pentagram.destroy();
		score += addScore;
		addScore += 100;
		scoreText.text = 'score: ' + score;
	}

	var pentagramPositions = {
		2: [game.world.width + 1170, game.world.height - 750],
		3: [game.world.width + 1670, game.world.height - 250],
		4: [game.world.width + 1470, game.world.height - 320],
		5: [game.world.width + 1470, game.world.height - 380],
		6: [game.world.width + 1700, game.world.height - 450],
		7: [game.world.width + 1450, game.world.height - 550],

	}

	if (platform1.position.x < -500) {
		var num = Math.round(Math.random() * (7 - 2) + 2);
		platform2 = game.add.sprite(game.world.width + 1200, game.world.height - 300, 'platform' + num);
		pentagram = game.add.sprite(pentagramPositions[num][0], pentagramPositions[num][1], 'pentagram')


		game.physics.p2.enable([platform2, pentagram], false);
		platform2.body.clearShapes();
		platform2.body.loadPolygon('physics', 'platform' + num, false);

		platform2.body.setMaterial(platformMaterial);

		velocity -= 25;
		platform2.body.static = true;
		pentagram.body.static = true;
		platform2.body.velocity.x = velocity;
		platform1 = platform2;
	}


	// platform1.body.velocity.x = -400;

	if (dashing) {

		player.animations.play('dash');
	} else {


		// player.animations.stop();
		player.animations.play('run');

	}


	if (jumpButton.isDown && player.body)
	{
			player.body.moveUp(400);
	} else {
		platform1.body.velocity.x = velocity;
	}

}

function checkIfCollidingY() {

    var yAxis = p2.vec2.fromValues(0, -1);
    var result = false;

    for (var i = 0; i < game.physics.p2.world.narrowphase.contactEquations.length; i++) {
        var c = game.physics.p2.world.narrowphase.contactEquations[i];

        if (explosion && explosion.body && (c.bodyA === explosion.body.data || c.bodyB === explosion.body.data)) {
					result = false;
				} else if (c.bodyA === player.body.data || c.bodyB === player.body.data) {

            var d = p2.vec2.dot(c.normalA, yAxis); // Normal dot Y-axis
            if (c.bodyA === player.body.data) d *= -1;
            if (d > 0.85) result = true;
        }
    }

    return result;

}

function checkIfCollidingX(object1, object2) {

    var xAxis = p2.vec2.fromValues(1, 0);
    var result = false;

    for (var i = 0; i < game.physics.p2.world.narrowphase.contactEquations.length; i++)
    {
        var c = game.physics.p2.world.narrowphase.contactEquations[i];

        if ((c.bodyA === object1.body.data && c.bodyB === object2.body.data || c.bodyB === object1.body.data && c.bodyA === object2.body.data))
        {
            var d = p2.vec2.dot(c.normalA, xAxis); // Normal dot Y-axis
            if (c.bodyA === object1.body.data) d *= -1;
            if (d > 0.9942) result = true;
        }
    }

    return result;

}


</script>
<!-- <script src="game.js"></script> -->
</body>
</html>
